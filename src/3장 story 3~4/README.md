# 라우터의 동작 원리와 부가 기능

> 발표일 `25.03.18`
>
> 발표자 `곽재영`

<br/>

## 목차

**story 03** : 라우터의 패킷 중계 동작

1. 라우터의 기본
2. 경로표에 등록된 정보
3. 라우터의 패킷 수신 동작
4. 경로표를 검색하여 출력 포트를 발견한다
5. 해당하는 경로가 없는 경우에 선택하는 기본 경로
6. 패킷은 유효 기한이 있다
7. 큰 패킷은 조각 나누기 기능으로 분할한다
8. 라우터의 송신 동작은 컴퓨터와 같다
9. 라우터와 스위칭 허브의 관계

**story 04** : 라우터의 부가 기능

1. 주소 변환으로 IP 주소를 효율적으로 이용한다
2. 주소 변환의 기본 동작
3. 포트 번호를 바꿔쓰는 이유
4. 인터넷에서 회사로 액세스한다
5. 라우터의 패킷 필터링 기능

<br/>

## Story 03 : 라우터의 패킷 중계 동작

### 1. 라우터의 기본
라우터는 IP 주소를 이용하여 네트워크 간 패킷을 중계하는 장비로, 크게 **중계 부분**과 **포트 부분**으로 구성된다.

- **중계 부분**
  - IP 패킷을 수신하여 목적지 IP 주소를 분석하고 중계 경로를 결정하는 기능을 담당
  - 패킷의 최적 경로를 판단하기 위해 내부의 **라우팅 테이블(경로표)** 을 참조
- **포트 부분**
  - 실제 물리적으로 패킷을 송수신하는 역할을 하며 IP 주소와 MAC 주소를 갖고 있음
  - LAN 어댑터와 비슷한 역할로 이더넷, 무선 LAN, ADSL 등 다양한 통신 기술을 지원 가능

### 2. 경로표에 등록된 정보
라우터는 경로표(라우팅 테이블)를 통해 중계 경로를 결정한다.

![image](https://github.com/user-attachments/assets/0cf93769-e57d-4793-8937-5266f2328db0)

경로표는 다음과 같은 항목들로 구성된다:
- **수신처**: IP 주소
  - 이 항목에 등록되어 있는 IP 주소와 수신한 패킷의 수신처 IP 주소를 비교하여 해당하는지 판단한다.
  - 이때, 호스트 번호 부분을 무시하고 네트워크 번호의 부분만 조사한다.
- **넷마스크**: 경로표의 수신처와 패킷의 수신처 주소를 대조할 때 비트 수
  - 주소 비교 동작을 실행할 때 네트워크 번호의 비트 수를 판단
- **게이트웨이 & 인터페이스**
  - 패킷의 중계 대상을 나타낸다.
  - '수신처' 항목과 '넷마스크' 항목에서 해당 행을 찾아내면 인터페이스 항목에 등록되어있는 인터페이스(포트)에서 게이트웨이 항목에 등록되어 있는 IP 주소를 가진 라우터에 대해 패킷을 중계한다.
- **메트릭**
  - 수신처 IP 주소에 기록되어 있는 목적지가 가까운지, 먼지를 나타낸다.

<br/>

**라우터의 경로표에 경로 정보를 등록하는 방법**
1. 사람이 수동으로 경로 정보를 등록/갱신
2. 라우팅 프로토콜(RIP, OSPF, BGP 등)이라는 구조를 사용하여 라우터들끼리 경로 정보를 교환하고 라우터가 자체에서 경로표에 등록

### 3. 라우터의 패킷 수신 동작
라우터는 포트에서 패킷을 수신하고, MAC 주소가 자신의 포트에 해당하는지 확인한 후 MAC 헤더를 제거하고 IP 헤더를 조사하여 중계 작업을 시작한다.

-> 라우터는 자신의 주소에 해당하는 패킷만 수신하고, 해당하지 않는 패킷은 폐기한다.

### 4. 경로표를 검색하여 출력 포트를 발견한다
라우터는 패킷 수신 후 가장 먼저 MAC 헤더를 폐기하고 IP 헤더를 조사하여 패킷의 목적지 IP 주소를 확인한다. 

라우터는 이 목적지 IP 주소와 경로표를 비교하여 중계할 출구 포트를 찾는다.

이때, 경로표의 넷마스크 값을 사용하여 목적지 IP 주소의 네트워크 부분만을 비교한다.

<br/>

여러 개의 경로가 목적지 IP 주소와 일치할 수 있는데, 이때 가장 긴 네트워크 번호(넷마스크가 큰 것)를 가진 경로를 우선 선택한다. 이것을 "최장 일치" 원칙이라고 한다.

최장 일치 원칙으로도 여러 경로가 동일한 경우에는 메트릭이 가장 작은 경로를 선택한다.

<br/>

만약 일치하는 경로가 하나도 없으면 라우터는 패킷을 폐기하고, ICMP 메시지를 사용하여 송신처에 이 사실을 알린다.

이렇게 하는 이유는 인터넷과 같이 매우 큰 규모의 네트워크에서 중계 대상을 모르는 패킷을 무작정 전송하면 네트워크 전체가 혼잡해질 수 있기 때문이다.

### 5. 해당하는 경로가 없는 경우에 선택하는 기본 경로
경로표에서 일치하는 항목이 없을 경우를 대비하여 기본 경로(**넷마스크 0.0.0.0**)가 존재한다.

넷마스크 항목이 0.0.0.0이라는 것은 패킷의 수신처 IP 주소와 경로표의 수신처 항목을 비교할 때의 비트 수가 0이라는 것이므로, 비교 동작을 실행하지 않아도 된다.

즉, 0.0.0.0인 경우 모든 주소에 일치하기 때문에 중계 대상이 분명하지 않는 경우는 생기지 않는다.

이 기본 경로는 일반적으로 인터넷으로 나가는 라우터를 등록해 둔다.

### 6. 패킷은 유효 기한이 있다
**TTL**(Time To Live, 생존 기간) 값은 패킷이 네트워크를 무한히 순환하는 것을 방지하기 위한 장치로, 라우터를 거칠 때마다 1씩 감소하며, 0이 되면 패킷은 폐기된다.

대부분 순환하는 일이 일어나지 않지만, 경로표에 등록된 정보에 오류가 있거나 기기의 고장 등으로 우회로로 전환될 때 일시적으로 경로가 혼란에 빠지면 이러한 현상이 발생한다.

### 7. 큰 패킷은 조각 나누기 기능으로 분할한다
라우터 포트가 전송할 수 있는 최대 전송 단위(MTU)보다 큰 패킷은 작게 나누어 중계된다.

분할이 불가능한 경우 ICMP 메시지를 통해 송신자에게 알린다.

<br/>

분할할 때에는 TCP 헤더 이후의 부분을 분할 대상 데이터로 간주한다.

TCP 헤더는 사용자 데이터가 아니지만, IP 입장에서 보면 TCP에서 송신을 의뢰받은 부분이므로 데이터가 된다.

이렇게 데이터를 분할한 후 여기에 IP 헤더를 덧붙인다.

![image](https://github.com/user-attachments/assets/e5b6b71a-4b0e-47a3-983f-101c078bed88)

### 8. 라우터의 송신 동작은 컴퓨터와 같다
라우터는 송신할 패킷에 MAC 헤더를 추가하고 수신처 MAC 주소를 ARP를 통해 찾아내 송신하는 방식으로, 컴퓨터의 LAN 어댑터 동작과 매우 유사하다.

### 9. 라우터와 스위칭 허브의 관계
라우터는 IP 기반으로 중계 경로를 판단하며, 스위칭 허브는 MAC 주소 기반으로 다음 라우터까지 패킷을 중계하는 역할을 수행한다.

따라서 전체 중계 작업은 라우터가 주도하며 스위칭 허브는 이를 지원하는 역할을 한다.

<br/>

## Story 04 : 라우터의 부가 기능

### 1. 주소 변환으로 IP 주소를 효율적으로 이용한다
인터넷 사용량 증가로 IP 주소 고갈 문제가 생기자, 이를 해결하기 위해 내부 네트워크에서 공통적으로 사용하는 주소 범위(프라이빗 주소)를 만들어 IP 주소를 효율적으로 관리하기 시작했다.

**프라이빗 주소와 글로벌 주소**
- **글로벌 주소(Global Address)**: 인터넷상에서 유일하게 관리되는 고유 IP 주소
- **프라이빗 주소(Private Address)**: 내부 네트워크에서만 사용하는 비공개 IP 주소
  ```
  10.0.0.0 ~ 10.255.255.255
  172.16.0.0 ~ 172.31.255.255
  192.168.0.0 ~ 192.168.255.255
  ```

![image](https://github.com/user-attachments/assets/ba148f9d-67ae-4680-b8e1-ff7bd918d9ce)

### 2. 주소 변환의 기본 동작
> NAT

라우터가 내부 네트워크에서 사용하는 프라이빗 IP 주소를 외부로 나갈 때 글로벌 IP 주소로 변환한다.

이 과정에서 포트 번호를 함께 변경하여 더 많은 내부 네트워크 기기를 적은 수의 글로벌 주소로 연결한다.

라우터 내부의 **대응표**를 이용해 패킷을 원활하게 중계하며, 내부 주소는 외부 네트워크에 노출되지 않는다.

![image](https://github.com/user-attachments/assets/23b9368a-8ae8-4a2e-9e01-6656a78726e4)

### 3. 포트 번호를 바꿔쓰는 이유
> NAPT

초기 NAT 방식은 IP 주소만 변환했기 때문에 인터넷에 동시 접속하는 기기 수만큼 글로벌 IP 주소가 필요했다.

이를 개선하기 위해 포트 번호도 함께 바꾸는 방식(NAPT)이 개발되었다.

포트 번호는 무작위로 선택할 수 있는 값이며, 이를 활용하면 하나의 글로벌 주소로 수만 개의 프라이빗 주소(16비트의 포트 번호 -> 65,536개)를 대응시킬 수 있어 IP 주소의 사용 효율이 크게 높아진다.

### 4. 인터넷에서 회사로 액세스한다
기본적으로 내부 기기가 먼저 인터넷에 접속 요청을 보내야 응답 패킷이 내부로 전달된다.

특정 서버를 외부에 공개하려면, NAT 장치에 미리 대응 관계를 수동으로 등록하여 외부 접근을 허용한다.

### 5. 라우터의 패킷 필터링 기능
라우터는 수신된 패킷의 헤더 정보를 분석하여 미리 설정된 규칙에 따라 허용 또는 차단함으로써, 네트워크의 보안을 강화하는 방화벽 기능을 수행한다.
